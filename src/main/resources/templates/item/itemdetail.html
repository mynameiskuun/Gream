<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <th:block th:replace="main/config :: config"></th:block>
</head>
<body>
<!-- header start-->
<th:block th:replace="main/header :: header"></th:block>
<!-- header end -->

    <div id="item-detail-wrapper">
        <div id="item-detail">
            <div id="item-img-box" th:style="'background-image: url('+ ${item.getThumbnailUrl()} + ');'">
            </div>
            <div id="item-information">
                <div id="item-name-box">
                    <h1>[[${item.getName()}]]</h1>
                </div>
                <div id="item-detail-box">
                    <h3>[[${item.getDetail()}]]</h3>
                </div>
                <div id="item-stock-box">
                    잔여수량 : [[${item.getItemStock()}]]
                </div>
                <div id="order-quantity-box">
                    <h4>주문 수량</h4>
                    <input type="number" name="orderQuantity" class="countBox" id="orderQuantity" value="1" min="1"/>
                </div>
                <div id="usable-coupon-box"><a>사용가능한 쿠폰을 확인하세요</a></div>
                <div id="item-price-box" th:text="${'판매가격 : ' + #numbers.formatInteger(item.getPrice(), 3, 'COMMA') + '원'} "></div>
                <div id="order-button-box">
                    <button class="btn btn-outline-secondary" id="orderBtn">주문하기</button>
                    <button class="btn btn-outline-secondary" id="cartBtn" onclick="cartBtn()">장바구니 추가</button>
                    <div class="item-like-box" th:if="${session.loginMember eq null}" style="background: white">
                        <div class="item-thumbs-up"></div>
                        <div class="like-title">좋아요</div>
                        <input type="hidden" th:value="${item.id}"/>
                        <input type="hidden" class="target" value="ITEM" />
                        <div class="like-counts" th:text="${likes.itemLikesCount}"></div>
                    </div>
                    <div class="item-like-box" th:style="'background: ' + ${likes.itemLikeBackgroundColorMap.get(session.loginMember.id)}" th:unless="${session.loginMember eq null} ">
                        <div class="item-thumbs-up"></div>
                        <div class="like-title">좋아요</div>
                        <input type="hidden" th:value="${item.id}"/>
                        <input type="hidden" class="target" value="ITEM" />
                        <div class="like-counts" th:text="${likes.itemLikesCount}"></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="item-review-box">
            <div id="item-detail-review-wrapper">
                    <div id="buyer-satisfied-score-box" class="card">
                    <div class="card-header text-center">
                        <span id="satisfied-rate" class="text-primary"></span><span>의 구매자가 만족했어요</span>
                    </div>
                    <div class="card-body">
                        <div id="rating-container">
                            <div class="rating-score">
                                <div class="satisfied-level"><span>매우 만족해요</span></div>
                                <div class="star-rating">
                                    <span class="star counted-stars text-primary">★★★★★</span>
                                </div>
                                <div class="graph-box">
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" id="5-star-progress-bar"></div>
                                    </div>
                                </div>
                                <div class="percentage text-warning"></div>
                            </div>
                            <div class="rating-score">
                                <div class="satisfied-level"><span>만족해요</span></div>
                                <div class="star-rating">
                                    <label class="star counted-stars text-primary">★★★★</label><label class="star non-count-star">★</label>
                                </div>
                                <div class="graph-box">
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" id="4-star-progress-bar"></div>
                                    </div>
                                </div>
                                <div class="percentage text-warning"></div>
                            </div>
                            <div class="rating-score">
                                <div class="satisfied-level">
                                    <span>보통이에요&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                                </div>
                                <div class="star-level">
                                    <label class="star counted-stars text-primary">★★★</label><label class="star non-count-star">★★</label>
                                </div>
                                <div class="graph-box">
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100" id="3-star-progress-bar"></div>
                                    </div>
                                </div>
                                <div class="percentage text-warning"></div>
                            </div>
                            <div class="rating-score">
                                <div class="satisfied-level">
                                    아쉬워요&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                </div>
                                <div class="star-level">
                                    <label class="star counted-stars text-primary">★★</label><label class="star non-count-star">★★★</label>
                                </div>
                                <div class="graph-box">
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" id="2-star-progress-bar"></div>
                                    </div>
                                </div>
                                <div class="percentage text-warning"></div>
                            </div>
                            <div class="rating-score">
                                <div class="satisfied-level">매우 아쉬워요</div>
                                <div class="star-level">
                                    <label class="star counted-stars text-primary">★</label><label class="star non-count-star">★★★★</label>
                                </div>
                                <div class="graph-box">
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="1-star-progress-bar"></div>
                                    </div>
                                </div>
                                <div class="percentage text-warning"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="review-header">
                    <div class="event-label outline-primary text-primary">EVENT</div>
                    <div class="review-event-text text-secondary">
                        사진 첨부 후기 작성 시 2,000원의 적립금을 드립니다.(직접 촬영한 사진 필수)
                    </div>
                    <div></div>
                </div>

                <div id="review-wrapper">
                    <div id="cards-wrapper">
                        <div id="review-container" th:each="reviewList : ${reviewList}">
                            <div class="review-cards">
                                <div class="review-top">회원 리뷰</div>
                                <div class="review-contents">
                                    <div class="review-left-box">
                                        <div class="review-header" style="justify-content: space-between; display: flex">
                                            <span th:text="${'작성자 : ' + reviewList.memberDto.name}"></span><span th:text="${#strings.substring(reviewList.createdTime, 0, 10)}"></span>
                                        </div>
                                        <div class="order-item-detail" style="display: flex">
                                            <div class="item-img" th:style="'background-image: url('+ ${reviewList.itemDto.thumbnailUrl} + ');'"></div>
                                            <div class="like-item-name" th:text="${reviewList.itemDto.name}"></div>
                                        </div>
                                        <div class="customer-star-rating-box">
                                    <span class="star counted-stars text-primary">
                                        <span class="review-star-value"></span>
                                        <input type="hidden" th:value="${reviewList.starValue}" />
                                    </span>
                                        </div>
                                        <div class="review-text" th:text="${reviewList.content}"></div>
                                        <div class="review-features-container">
                                            <div class="review-item-features text-secondary review-item-price-score" style="border: 1px solid; border-radius: 10px; width: 150px; text-align: center;">
                                                <span class="feature-title">상품 가격</span>
                                                <span class="feature-evaluate text-dark" style="font-weight: 500" th:if="${reviewList.priceScore == 1}">비싸요</span>
                                                <span class="feature-evaluate text-dark" style="font-weight: 500" th:if="${reviewList.priceScore == 2}">보통이에요</span>
                                                <span class="feature-evaluate text-dark" style="font-weight: 500" th:if="${reviewList.priceScore == 3}">저렴해요</span>
                                            </div>
                                            <div class="review-item-features text-secondary review-item-quality-score" style="border: 1px solid; border-radius: 10px; width: 150px; text-align: center;">
                                                <span class="feature-title">상품 품질</span>
                                                <span class="feature-evaluate text-dark" style="font-weight: 500" th:if="${reviewList.qualityScore == 1}">나빠요</span>
                                                <span class="feature-evaluate text-dark" style="font-weight: 500" th:if="${reviewList.qualityScore == 2}">보통이에요</span>
                                                <span class="feature-evaluate text-dark" style="font-weight: 500" th:if="${reviewList.qualityScore == 3}">좋아요</span>
                                            </div>
                                            <div class="review-item-features text-secondary review-item-delivery-score" style="border: 1px solid; border-radius: 10px; width: 150px; text-align: center;">
                                                <span class="feature-title">상품 배송</span>
                                                <span class="feature-evaluate text-dark" style="font-weight: 500" th:if="${reviewList.deliveryScore == 1}">느려요</span>
                                                <span class="feature-evaluate text-dark" style="font-weight: 500" th:if="${reviewList.deliveryScore == 2}">보통이에요</span>
                                                <span class="feature-evaluate text-dark" style="font-weight: 500" th:if="${reviewList.deliveryScore == 3}">빨라요</span>
                                            </div>
                                            <div class="review-item-features text-secondary review-item-repurchase-score" style="border: 1px solid; border-radius: 10px; width: 150px; text-align: center;">
                                                <span class="feature-title">재구매 의사</span>
                                                <span class="feature-evaluate text-dark" style="font-weight: 500" th:if="${reviewList.repurchaseScore == 1}">없어요</span>
                                                <span class="feature-evaluate text-dark" style="font-weight: 500" th:if="${reviewList.repurchaseScore == 2}">보통이에요</span>
                                                <span class="feature-evaluate text-dark" style="font-weight: 500" th:if="${reviewList.repurchaseScore == 3}">있어요</span>
                                            </div>
                                        </div>
                                        <div class="review-like-box">
                                            <div class="review-thumbs-up"></div>
                                            <div class="like-title">도움돼요</div>
                                            <input type="hidden" th:value="${reviewList.id}"/>
                                            <div class="like-counts"></div>
                                            <input type="hidden" class="target" value="REVIEW" />
                                        </div>
                                    </div>
                                    <div class="review-right-box">
                                        <div class="customer-review-img-box" th:style="'background-image: url('+ ${reviewList.thumbnail} + ');'"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="review-reply-box">
                                <div class="review-reply-header">
                                    <span>댓글&nbsp;</span>
                                    <span class="reply-counts text-secondary">2</span>
                                    <span class="text-secondary">개</span>
                                </div>
                                <div id="reply-input-container">
                                    <div id="reply-input-box">
                                        <textarea type="textarea" class="form-control" id="reply-input-area" onfocus="replyAreaToggle()"></textarea>
                                        <input type="button" class="btn btn-outline-secondary" value="작성"/>
                                    </div>
                                </div>
                                <div class="reply-output-container">
                                    <div class="reply-cards">
                                        <div class="reply-center-box">
                                            <div class="reply-writer-id">id</div>
                                            <div class="reply-context-box">
                                                댓글내용 Lorem ipsum dolor sit amet consectetur adipisicing elit. Nece
                                            </div>
                                        </div>
                                        <div class="reply-like-box">
                                            <div class="reply-thumbs-up"></div>
                                            <div class="reply-like-counts">2</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        <div id="item-qna-box">
            문의란
            <span>
                Lorem ipsum dolor sit amet, consectetur adipisicing elit. Fuga maiores, quis minima incidunt voluptatibus error consectetur et reprehenderit. Repellendus laudantium voluptates ad doloremque neque dolore error dolorum soluta temporibus suscipit.
            </span>
            <!-- 문의란. 게시판 형식으로 페이징 처리 -->
            <!-- ajax 비동기 렌더링 -->
            <!-- 11번가 참고 -->
        </div>
        <!--   footer start   -->
        <th:block th:replace="main/footer :: footer"></th:block>
        <!--   footer end   -->
    </div>


    <!--  modal start  -->
        <div class="modal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Modal title</h5>
                        <button type="button" class="btn-close"
                                data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p id="cartText">장바구니에 추가 되었습니다.</p>
                        <div class="form-group">
                            <div class="starrr"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary"
                                data-bs-dismiss="modal">쇼핑 계속하기</button>
                        <button type="button"
                                class="btn-primary tocart-btn">장바구니로</button>
                    </div>
                </div>
            </div>
        </div>
    <!--  modal end  -->

    <!-- Bootstrap core JS-->
    <!--  모달 사용을 위해  -->
    <script src="/js/itemdetail.js"></script>
<!--</div>-->

<script th:inline="javascript">
    /*<![CDATA[*/


    /* 구매수량 변화 감지, 남은 재고수량 이상으로 장바구니 혹은 결제 안되게 뷰단에서 처리 */
    // 페이지에 나와있는 상품 재고 초과하여 카운트 up 시 alert 출력
    $(".countBox").on('propertychange change keyup paste input', function() {
        let currentVal = $('#orderQuantity').val();
        let stock = [[${item.itemStock}]];
        console.log(currentVal);
        if(currentVal > stock) {
            alert('주문 가능한 수량을 초과 하였습니다.');
            $('#orderQuantity').val(stock);
        }
        if(stock === 0) {
            alert(`품절된 상품입니다`);
        }
    });

    // 장바구니 추가 버튼 메소드
    function cartBtn() {

        if([[${session.loginMember}]] == null) {
            alert('로그인을 해주세요')
            location.href='/login';
        }

        let cartItem = {
            itemDto : [[${item}]],
            quantity : document.getElementById('orderQuantity').value
        };

        $.ajax({
            url: '/cart',
            type: 'POST',
            data: JSON.stringify(cartItem),
            contentType: 'application/json; charset=UTF-8',
            dataType: 'text',
            success: function(result) {
                document.getElementById("cartText").innerText = result;
                const modal = new bootstrap.Modal(document.querySelector('.modal'));
                modal.show();
            }
        })
    }

    // 개별상품 주문 이벤트 메소드
    $('#orderBtn').click(function () {

        if([[${session.loginMember}]] == null) {
            alert('로그인을 해주세요')
            location.href = '/login';
        }

        let data = {
            quantity : $('#orderQuantity').val(),
            itemDto : [[${item}]]
        }

        $.ajax({
            url : "/order",
            type: "POST",
            contentType: "application/JSON; charset=UTF-8;",
            data: JSON.stringify(data),
            dataType: "text",
            success: function (itemStockFlag) {
                if (itemStockFlag) {
                    location.href="/order?itemId=" + data.itemDto.id + "&quantity=" + data.quantity;
                } else {
                    alert("상품이 품절 되었습니다.");
                }
            },
            error: function(error) {
                console.log(error);
            }
        })


    })

    // 모달창 장바구니 버튼 이벤트 메소드
    $('.tocart-btn').click(function() {
        location.href='/cart';
    })


    $("#reply-input-container").on("focus", function () {
        $("#reply-input-area").css("height", "100px");
    });

    // 댓글란 토글
    function replyAreaToggle() {
        $("#reply-input-area").css("height", "100px");
    }

    // 상품 구매 후기 만족도 조사 이벤트
    // window.onload = function() {
    $(document).ready(function() {

        // 리뷰 작성자의 별 점수 출력 이벤트
        $('.review-star-value').each(function() {
            $(this).html('★'.repeat($(this).next('input[type="hidden"]').val()));
        })

        let starMap = [[${starValMap}]];
        let size = [[${starValMap[0]}]]
        let sum = 0;
        let originalPercentage;
        let roundedPercentage;
        let progressDomList = document.querySelectorAll('.progress-bar');
        let percentageDomList = document.querySelectorAll('.percentage');

        console.log("starMap" + starMap);

        if (size === 0) {
            $('#satisfied-rate').html("아직 리뷰가 등록되지 않은 상품입니다.");
            $('#satisfied-rate').next().html("");
            for (let i = 0; i <= 4; i++) {
                percentageDomList[i].innerHTML = "0%";
            }
        } else {
            $('#satisfied-rate').html(getSatisfiedRate(starMap) + '%');
            for(let i=1; i<=5; i++) {
                originalPercentage = starMap[i] / size * 100.0;
                progressDomList[5-i].style.width = originalPercentage + '%';
                roundedPercentage = Math.round(originalPercentage);
                percentageDomList[5-i].innerHTML = roundedPercentage + "%";
                sum += roundedPercentage;
            }
        }

        console.log("map : " + starMap);
        console.log('mapSize = ' + size);
        console.log(starMap[1])
        console.log("git test")

        // for (let i = 1; i <= 5; i++) {
        //     size += starMap[i];
        //     console.log("starMap["+i+"] : " + starMap[i])
        // }

        starMap = 0;
        size = 0;
    })

    // 상품후기 긍정 평가 비율 계산 이벤트
    function getSatisfiedRate(scoreMap) {
        return Math.round((scoreMap[4] / scoreMap[0] * 100.0) + (scoreMap[5] / scoreMap[0] * 100.0))
    }


    // 상품 좋아요 click 이벤트
    function itemLike() {

        // 좋아요 이벤트 시 필요한 데이터
        // 해당 타겟 id(리뷰? 아이템?)
        // 로그인 사용자 id
        // 좋아요 타겟(리뷰? 아이템?)

        let clickedElement = $(this);
        let memberDto;
        // let itemId = $(this).parent().find('input[type="hidden"]').val();

        if ([[${session.loginMember}]] == null) {
            alert('로그인을 해주세요');
            location.href = '/login';
        } else
            memberDto = [[${session.loginMember}]]

        let data = {
            "itemDto" : [[${item}]],
            "memberDto" : memberDto,
        };

        $.ajax({
            url: '/item/like',
            type: 'POST',
            contentType: 'application/json; charset=UTF-8',
            dataType : 'JSON',
            data: JSON.stringify(data),
            success(result) {
                console.log(result);
                clickedElement.parent().find('div.like-counts').html(result.count);
                clickedElement.parent().css('background-color', result.backgroundColor);
            },
            error(result) {
                console.log(result)
            }
        })
    }

    // 로그인, 리뷰 좋아요 유무에 따른 css 변경 이벤트
    // window.onload = function() {
    //
    //     let itemId = [[${item.id}]];
    //     let reviewList = [[${reviewList}]] || [];
    //     let commentList = [[${commentList}]] || [];
    //
    //     let reviewIdList = [];
    //     let commentIdList = [];
    //
    //     reviewList.forEach((review) => {
    //         reviewIdList.push(review.id);
    //     });
    //
    //     commentList.forEach((comment) => {
    //         commentIdList.push(comment.id)
    //     })
    //
    //     console.log("itemId : " + itemId);
    //     console.log("reviewList : " + reviewList);
    //     console.log("reviewIdList : " + reviewIdList);
    //     console.log("commentList : " + commentList);
    //     console.log("commentIdList : " + commentIdList);
    //
    //     let data = {
    //         "itemId" : itemId,
    //         "reviewIdList": reviewIdList,
    //         "commentIdList" : commentIdList
    //     }
    //
    //     // 보내야 할 데이터
    //     // item id, review id list, comment id list
    //     // 로그인 유저 id
    //
    //     // 로그인 안했으면 좋아요 count 표시.
    //     // 로그인 했고 좋아요 안눌렀으면 count 표시.
    //     // 로그인 했고 좋아요 눌렀으면 배경색 바꾸고 count 표시.
    //
    //     $.ajax({
    //         url: '/test/likecheck',
    //         method: 'POST',
    //         contentType: 'application/JSON; charset=UTF-8',
    //         dataType: 'JSON',
    //         data: JSON.stringify(data),
    //         success: function (result) {
    //             console.log(JSON.parse(result))
    //         },
    //         error: function (error) {
    //             console.log(error)
    //         },
    //     })
    // }

    $('.item-thumbs-up').click(itemLike);
    // $('.review-thumbs-up').click(like);

    /*]]*/
</script>
</body>
</html>